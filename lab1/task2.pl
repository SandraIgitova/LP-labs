%представление номер 1.

student(102,'Петров').
student(101,'Петровский').
student(104,'Иванов').
student(102,'Ивановский').
student(104,'Запорожцев').
student(101,'Сидоров').
student(103,'Сидоркин').
student(102,'Биткоинов').
student(103,'Эфиркина').
student(103,'Сиплюсплюсов').
student(103,'Программиро').
student(104,'Джаво').
student(103,'Клавиатурникова').
student(101,'Мышин').
student(104,'Фулл').
student(101,'Безумников').
student(102,'Шарпин').
student(104,'Круглосчиталкин').
student(103,'Решетников').
student(102,'Эксель').
student(102,'Текстописов').
student(103,'Текстописова').
student(101,'Густобуквенникова').
student(102,'Криптовалютников').
student(104,'Блокчейнис').
student(102,'Азурин').
student(103,'Вебсервисов').
student(102,'Круглотличников').
subject('LP','Логическое программирование').
subject('MTH','Математический анализ').
subject('FP','Функциональное программирование').
subject('INF','Информатика').
subject('ENG','Английский язык').
subject('PSY','Психология').
grade('Петров','LP',4).
grade('Петров','MTH',3).
grade('Петров','FP',5).
grade('Петров','INF',4).
grade('Петров','ENG',4).
grade('Петров','PSY',3).
grade('Петровский','LP',5).
grade('Петровский','MTH',5).
grade('Петровский','FP',5).
grade('Петровский','INF',4).
grade('Петровский','ENG',5).
grade('Петровский','PSY',3).
grade('Иванов','LP',5).
grade('Иванов','MTH',3).
grade('Иванов','FP',4).
grade('Иванов','INF',5).
grade('Иванов','ENG',5).
grade('Иванов','PSY',5).
grade('Ивановский','LP',3).
grade('Ивановский','MTH',5).
grade('Ивановский','FP',4).
grade('Ивановский','INF',3).
grade('Ивановский','ENG',5).
grade('Ивановский','PSY',5).
grade('Запорожцев','LP',2).
grade('Запорожцев','MTH',2).
grade('Запорожцев','FP',4).
grade('Запорожцев','INF',3).
grade('Запорожцев','ENG',4).
grade('Запорожцев','PSY',4).
grade('Сидоров','LP',4).
grade('Сидоров','MTH',4).
grade('Сидоров','FP',4).
grade('Сидоров','INF',4).
grade('Сидоров','ENG',3).
grade('Сидоров','PSY',4).
grade('Сидоркин','LP',4).
grade('Сидоркин','MTH',5).
grade('Сидоркин','FP',4).
grade('Сидоркин','INF',3).
grade('Сидоркин','ENG',4).
grade('Сидоркин','PSY',4).
grade('Биткоинов','LP',5).
grade('Биткоинов','MTH',4).
grade('Биткоинов','FP',3).
grade('Биткоинов','INF',4).
grade('Биткоинов','ENG',3).
grade('Биткоинов','PSY',2).
grade('Эфиркина','LP',2).
grade('Эфиркина','MTH',4).
grade('Эфиркина','FP',3).
grade('Эфиркина','INF',2).
grade('Эфиркина','ENG',2).
grade('Эфиркина','PSY',4).
grade('Сиплюсплюсов','LP',4).
grade('Сиплюсплюсов','MTH',4).
grade('Сиплюсплюсов','FP',4).
grade('Сиплюсплюсов','INF',5).
grade('Сиплюсплюсов','ENG',4).
grade('Сиплюсплюсов','PSY',4).
grade('Программиро','LP',5).
grade('Программиро','MTH',4).
grade('Программиро','FP',3).
grade('Программиро','INF',3).
grade('Программиро','ENG',5).
grade('Программиро','PSY',4).
grade('Джаво','LP',4).
grade('Джаво','MTH',4).
grade('Джаво','FP',3).
grade('Джаво','INF',2).
grade('Джаво','ENG',3).
grade('Джаво','PSY',5).
grade('Клавиатурникова','LP',4).
grade('Клавиатурникова','MTH',5).
grade('Клавиатурникова','FP',3).
grade('Клавиатурникова','INF',5).
grade('Клавиатурникова','ENG',4).
grade('Клавиатурникова','PSY',4).
grade('Мышин','LP',5).
grade('Мышин','MTH',4).
grade('Мышин','FP',5).
grade('Мышин','INF',4).
grade('Мышин','ENG',3).
grade('Мышин','PSY',3).
grade('Фулл','LP',4).
grade('Фулл','MTH',4).
grade('Фулл','FP',4).
grade('Фулл','INF',5).
grade('Фулл','ENG',5).
grade('Фулл','PSY',5).
grade('Безумников','LP',3).
grade('Безумников','MTH',5).
grade('Безумников','FP',3).
grade('Безумников','INF',2).
grade('Безумников','ENG',4).
grade('Безумников','PSY',3).
grade('Шарпин','LP',3).
grade('Шарпин','MTH',4).
grade('Шарпин','FP',4).
grade('Шарпин','INF',5).
grade('Шарпин','ENG',5).
grade('Шарпин','PSY',5).
grade('Круглосчиталкин','LP',5).
grade('Круглосчиталкин','MTH',2).
grade('Круглосчиталкин','FP',4).
grade('Круглосчиталкин','INF',3).
grade('Круглосчиталкин','ENG',4).
grade('Круглосчиталкин','PSY',3).
grade('Решетников','LP',4).
grade('Решетников','MTH',4).
grade('Решетников','FP',5).
grade('Решетников','INF',3).
grade('Решетников','ENG',5).
grade('Решетников','PSY',3).
grade('Эксель','LP',4).
grade('Эксель','MTH',4).
grade('Эксель','FP',4).
grade('Эксель','INF',3).
grade('Эксель','ENG',5).
grade('Эксель','PSY',4).
grade('Текстописов','LP',2).
grade('Текстописов','MTH',5).
grade('Текстописов','FP',4).
grade('Текстописов','INF',3).
grade('Текстописов','ENG',5).
grade('Текстописов','PSY',3).
grade('Текстописова','LP',4).
grade('Текстописова','MTH',4).
grade('Текстописова','FP',4).
grade('Текстописова','INF',3).
grade('Текстописова','ENG',5).
grade('Текстописова','PSY',2).
grade('Густобуквенникова','LP',5).
grade('Густобуквенникова','MTH',2).
grade('Густобуквенникова','FP',4).
grade('Густобуквенникова','INF',5).
grade('Густобуквенникова','ENG',4).
grade('Густобуквенникова','PSY',3).
grade('Криптовалютников','LP',5).
grade('Криптовалютников','MTH',2).
grade('Криптовалютников','FP',2).
grade('Криптовалютников','INF',3).
grade('Криптовалютников','ENG',4).
grade('Криптовалютников','PSY',2).
grade('Блокчейнис','LP',5).
grade('Блокчейнис','MTH',2).
grade('Блокчейнис','FP',5).
grade('Блокчейнис','INF',3).
grade('Блокчейнис','ENG',4).
grade('Блокчейнис','PSY',5).
grade('Азурин','LP',4).
grade('Азурин','MTH',2).
grade('Азурин','FP',4).
grade('Азурин','INF',3).
grade('Азурин','ENG',5).
grade('Азурин','PSY',2).
grade('Вебсервисов','LP',3).
grade('Вебсервисов','MTH',4).
grade('Вебсервисов','FP',3).
grade('Вебсервисов','INF',3).
grade('Вебсервисов','ENG',5).
grade('Вебсервисов','PSY',2).
grade('Круглотличников','LP',4).
grade('Круглотличников','MTH',3).
grade('Круглотличников','FP',5).
grade('Круглотличников','INF',5).
grade('Круглотличников','ENG',3).
grade('Круглотличников','PSY',5).

%- Вариант 3 
%- Для каждого студента, найти средний балл, и сдал ли он экзамены или нет
%- Для каждого предмета, найти количество не сдавших студентов
%- Для каждой группы, найти студента (студентов) с максимальным средним баллом

%- Для каждого студента, найти средний балл, и сдал ли он экзамены или нет
task1() :- 
    findall(X, student(_, X), StudentsList),
    get_average_grade(StudentsList, Grades, Passed),
    print_average_grade(StudentsList, Grades),
    print_pass(StudentsList, Passed).

get_average_grade([], [], []) :- !.
get_average_grade([X|T], RG, RP) :- 
    findall(Grade, grade(X,_,Grade), Grades),
    get_list_sum(Grades, Sum),
    check_for_pass(Grades, Pass),
    length(Grades, Length),
    Average is Sum / Length,
    get_average_grade(T, R1, R2),
    append([Average], R1, RG),
    append([Pass], R2, RP).

print_average_grade([],[]).
print_average_grade([S|ST],[G|GT]) :- 
    write("Student "), write(S), write(" has average grade "),write(G), nl,
    print_average_grade(ST, GT).

print_pass([],[]).
print_pass([S|ST], [P|PT]) :- 
    P = true, 
    write("Student "), write(S), write(" passed the exams"), nl,
    print_pass(ST, PT).
print_pass([S|ST], [P|PT]) :- 
    P = false, 
    write("Student "), write(S), write(" not passed the exams"), nl,
    print_pass(ST, PT).

get_list_sum([], 0).
get_list_sum([X|T], R) :-
    get_list_sum(T, R1), R is R1 + X.

check_for_pass([], true).
check_for_pass([X|XT], R) :-
    X =< 2, R = false.
check_for_pass([X|XT], R) :-
    X >= 3, check_for_pass(XT, R).

%- Для каждого предмета, найти количество не сдавших студентов
task2() :- 
    findall(X, subject(X,_), Subjects),
    count_failed_students(Subjects, Failed),
    print_failed(Subjects, Failed).

count_failed_students([], []).
count_failed_students([Subj|SubjT], R) :-
    findall(X, grade(X, Subj, 2), FailedList),
    length(FailedList,CurCount),
    count_failed_students(SubjT, Count),
    append([CurCount], Count, R).

print_failed([],[]).
print_failed([S|ST], [C|CT]) :-
    subject(S, TextSubject),
    write("Count of students failed "), write(TextSubject), write(" is "), write(C), nl,
    print_failed(ST, CT).

%- Для каждой группы, найти студента (студентов) с максимальным средним баллом

task3() :- 
    findall(X, student(X,_), BadGroups),
    sort(BadGroups, Groups),
    find_students_in_group(Groups, ListOfStudents),
    print_students_in_group(Groups, ListOfStudents).


find_students_in_group([], []).
find_students_in_group([G|GT], R) :-
    findall(X, student(G, X), Students),
    get_average_grade(Students, Grades, _),
    get_students_with_max_grade(Students, Grades, _ , List),
    find_students_in_group(GT, R1),
    R = [List|R1].


get_students_with_max_grade([],[], 0, []).
get_students_with_max_grade([St|StT],[Gr|GrT], MaxGrade, R) :-
    get_students_with_max_grade(StT, GrT, OldGrade, R1),
    OldGrade > Gr,
    MaxGrade is OldGrade,
    R = R1.

get_students_with_max_grade([St|StT],[Gr|GrT], MaxGrade, R) :-
    get_students_with_max_grade(StT, GrT, OldGrade, R1),
    OldGrade =:= Gr,
    MaxGrade is OldGrade,
    append([St], R1, R).

get_students_with_max_grade([St|StT],[Gr|GrT], MaxGrade, R) :-
    get_students_with_max_grade(StT, GrT, OldGrade, R1),
    OldGrade < Gr,
    MaxGrade is Gr,
    R = [St].


print_students_in_group([], []).
print_students_in_group([Gr|GrT], [Sts|StsT]) :- 
    length(Sts, 1),
    write("Best students in group "), write(Gr), write(" is "), write(Sts), nl,
    print_students_in_group(GrT,StsT).
print_students_in_group([Gr|GrT], [Sts|StsT]) :- 
    not(length(Sts, 1)),
    write("Best students in group "), write(Gr), write(" are "), write(Sts), nl,
    print_students_in_group(GrT,StsT).